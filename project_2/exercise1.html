<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Leaflet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background-color: #ffffff;
            border-style: solid;
            border-color: black;
            border-width: 1px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
        }

        #map_canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="initialize()">
<div id="map_canvas"></div>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>

<script type="text/javascript" src="states-data.js"></script>
<script>
    let c_name = "CNTRY_NAME,C,254";
    let c_continent = "FIRST_FIRS,C,25";

    let a_name = 'CNTRY_NAME,C,40';
    let a_pop = 'POP_ADMIN,N,9,0';
    let a_area = "SQKM,N,12,2";


    let countries;

    function csvJSON(csv) {
        //console.log(csv);

        lines = csv.split("\n");
        //console.log(lines);
        var result = [];

        var headers = lines[0].split(";");
        //console.log(headers);
        for (var i = 1; i < lines.length; i++) {
            var obj = {};
            var currentline = lines[i].split(";");
            for (var j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j];
            }
            result.push(obj);
        }
        return result; //JavaScript object
        //return JSON.stringify(result); //JSON
    }

    function getColor(density) {
        return density > 400 ? '#001a09' :
            density > 300 ? '#003311' :
                density > 200 ? '#004d1a' :
                    density > 150 ? '#006622' :
                        density > 100 ? '#00802b' :
                            density > 70 ? '#00b33c' :
                                density > 40 ? '#00e64d' :
                                    density > 20 ? '#1aff66' :
                                        density > 10 ? '#66ff99' :
                                                '#ccffdd';
    }

    function style(feature) {
        let name = feature.properties.NAME;

        console.log(name);

        let color = countries.has(name) ? getColor(countries.get(name)[0] / countries.get(name)[1]) : '#ffffff';

        return {
            fillColor: color,
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.8
        };
    }

    function GetPopulations(administrations) {
        // filters useless data
        let densities = new Map();

        let useless = ['FIPS_ADMIN,C,4', 'GMI_ADMIN,C,254', 'ADMIN_NAME,C,42', 'FIPS_CNTRY,C,2', 'GMI_CNTRY,C,3', 'TYPE_ENG,C,26', 'TYPE_LOC,C,50',
            'SQMI,N,12,2', 'COLOR_MAP,C,2', 'test,N,5,3', 'test2,N,5,3'];

        for (let entry of administrations) {
            for (info of useless) {
                delete entry[info]
            }

            administration_name = entry[a_name];
            administration_population = entry[a_pop];
            administration_area = entry[a_area];

            let pop = parseInt(administration_population);
            adjusted_pop = (pop > 0) ? pop : 0;

            let area = parseInt(administration_area);

            if (densities.has(administration_name)) {
                let temp_values = densities.get(administration_name);

                temp_values[0] += adjusted_pop;
                temp_values[1] += area;

                densities.set(administration_name, temp_values);
            } else {
                densities.set(administration_name, [adjusted_pop, area]);
            }
        }
        return densities;
    }

    function OldGetDensity(populations, admin) {
        console.log("tt")
        console.log(admin);

        let densities = new Map()

        for (const [key, value] of populations.entries()) {
            console.log(value);
            console.log(admin[a_area]);
            let density = value / admin[a_area];

            densities.set(key, density);
        }

        return densities;

    }

    function initialize() {
        let map;

        map = L.map('map_canvas').setView([48.75, 9.21], 5);

        let osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            minZoom: 2,
            maxZoom: 18
        }).addTo(map);

        Promise.all([
            fetch('http://localhost:8003/countries3.csv'),
            fetch('http://localhost:8003/admin.csv')
        ]).then(values => Promise.all(values.map(v => v.text())))
            .then(result => {
                //countries = csvJSON(result[0]); // not necessary anymore, calculating density countries outside europe too

                administrations = csvJSON(result[1]);

                countries = GetPopulations(administrations);

                L.geoJson(statesData, {style: style}).addTo(map);

                var legend = L.control({position: 'bottomright'});

                legend.onAdd = function (map) {

                    var div = L.DomUtil.create('div', 'info legend'),
                        grades = [0, 10, 20, 40, 70, 100, 150, 200, 300, 400],
                        labels = ["<strong> Einwohner pro km² </strong>"], from, to;

                    for (var i = 0; i < grades.length; i++) {
                        from = grades[i];
                        to = grades[i + 1];

                        labels.push(
                            '<i style="background:' + getColor(from + 1) + '"></i> ' +
                            from + (to ? '&ndash;' + to : '+'));
                    }
                    div.innerHTML = labels.join('<br>');
                    return div;


                };
                //     // loop through our density intervals and generate a label with a colored square for each interval
                //     for (var i = 0; i < grades.length; i++) {
                //         div.innerHTML +=
                //             '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                //             grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                //     }
                //
                //     return div;
                // };
                legend.addTo(map);

            })
        ;

    }
</script>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous">
</script>
</body>

</html>
