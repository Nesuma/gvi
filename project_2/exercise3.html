<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <value>Leaflet</value>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #map_canvas {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body onload="initialize()">
<div id="map_canvas"></div>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
<script type="text/javascript" src="states-data.js"></script>
<script>
    var map;
    const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
    const geocodeParams = '&format=json&limit=1';

    drop_icons = [];

    function GetDrops(path) {
        for (i = 0; i <= 10; i++) {
            let factor = (10 + 10-i) / 10;
            drop_icons[i] = L.icon({
                iconUrl: path + '/drop' + (i * 10) + '.png',
                iconSize: [20 * factor, 35 * factor], // size of the icon
                iconAnchor: [20, 30],
                popupAnchor: [0, -32]
            });
        }
        console.log(drop_icons);

    }

    var country_code_mapping = new Map([
        [ "Belarus","112"],
        [ "Bulgaria","100"],
        [ "Czechia","203"],
        [ "Czech Republic","203"],
        [ "Hungary","348"],
        [ "Moldova","498"],
        [ "Poland","616"],
        [ "Romania","642"],
        [ "Russia","643"],
        [ "Slovakia","703"],
        [ "Ukraine","804"],
        [ "Denmark","208"],
        [ "Estonia","233"],
        [ "Faroe Island","234"],
        [ "Faroe Is.","234"],
        [ "Finland","246"],
        [ "Iceland","352"],
        [ "Ireland","372"],
        [ "Isle of Man","833"],
        [ "Latvia","428"],
        [ "Lithuania","440"],
        [ "Norway","578"],
        [ "Sweden","752"],
        [ "United Kingdom","826"],
        [ "Albania","008"],
        [ "Andorra","020"],
        [ "Bosnia and Herzegovina","070"],
        [ "Bosnia & Herzegovina","070"],
        [ "Croatia","191"],
        [ "Gibraltar","292"],
        [ "Greece","300"],
        [ "Italy","380"],
        [ "Macedonia","807"],
        [ "Malta","470"],
        [ "Montenegro","499"],
        [ "Portugal","620"],
        [ "San Marino","674"],
        [ "Serbia and Montenegro","688"],
        [ "Serbia & Montenegro","688"],
        [ "Slovenia","705"],
        [ "Austria","040"],
        [ "Belgium","056"],
        [ "France","250"],
        [ "Germany","276"],
        [ "Liechtenstein","438"],
        [ "Luxembourg","442"],
        [ "Monaco","492"],
        [ "Netherlands","528"],
        [ "Switzerland","756"],
        [ "Spain","724"],
        ["Svalbard and Jan Mayen Islands","744"],
        ["Svalbard","744"],
        ["Jan Mayen","744"],
        ["Guernsey"	,"831"],
        ["Jersey","832"],
        ["Sark","680"],
        ["Holy See","336"],
        ["Vatican City","336"],
        ["Vatican","336"]

    ]);

    var areaCodes = [
        "112", // Belarus
        "100", // Bulgaria
        "203", // Czechia
        "348", // Hungary
        "498", // Moldova
        "616", // Poland
        "642", // Romania
        "643", // Russia
        "703", // Slovakia
        "804", // Ukraine
        "208", // Denmark
        "233", // Estonia
        "234", // Faroe Island
        "246", // Finland
        "352", // Iceland
        "372", // Ireland
        "833", // Isle of Man
        "428", // Latvia
        "440", // Lithuania
        "578", // Norway
        "752", // Sweden
        "826", // UK
        "008", // Albania
        "020", // Andorra
        "070", // Bosnia
        "191", // Croatia
        "292", // Gibraltar
        "300", // Greece
        "380", // Italy
        "807", // Macedonia
        "470", // Malta
        "499", // Montenegro
        "620", // Portugal
        "674", // San Marino
        "688", // Serbia
        "705", // Slovenia
        "040", // Austria
        "056", // Belgium
        "250", // France
        "276", // Germany
        "438", // Liechtenstein
        "442", // Luxembourg
        "492", // Monaco
        "528", // Netherlands
        "756", // Switzerland
        "724", // Spain
    ];

    var timePeriods = [
        "2015",
        "2016",
        "2017"
    ]

    function GetTimePeriods() {
        result = "";
        timePeriods.forEach(element => {
            result += ("&timePeriod=" + element);
        })
        return result;
    }

    function GetAreaCodes() {
        result = "";
        areaCodes.forEach(element => {
            result += ("&areaCode=" + element);
        })
        return result;
    }

    function loadJSON(code,year,callback) {
        let request = new XMLHttpRequest();
        request.overrideMimeType("application/json");
        // request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2&areaCode=' + code + "&timePeriod=" + year + '&dimensions=[{Location:"ALLAREA"}]', true);
        request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2&areaCode=' + code + "&timePeriod=" + year, true);
        request.onreadystatechange = function () {
            if (request.readyState == 4 && request.status == "200") {
                callback(request.responseText);
            }
        };
        request.send(null);
    }

    function DataObject(country, indicator, year, value) {
        this.country = country;
        this.indicator = indicator;
        this.year = year;
        this.value = value;
    }

    function YearObject(year) {
        this.year = year;
        this.water = new Map();
        this.soap = new Map();
    }

    let objects = [];

    function getEuropeanCountries(json) {
        let features = [];
        for (let i = 0; i < json.features.length; i++) {
            if (json.features[i].properties.FIRST_FIRS === "Europe") {
                features.push(json.features[i]);
            }
        }
        json.features = features;
        return json;
    }

    function l(i){
            console.log(i);
    }

    function initialize() {
        GetDrops("images");

        map = L.map('map_canvas').setView([53.81, 14.16], 3.5);

        let osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            minZoom: 2,
            maxZoom: 18
        }).addTo(map);

        shp("files/World/Cntry00").then(countries => {

            // console.log(countries);

            let european_countries = getEuropeanCountries(countries);
            // console.log(european_countries);

            for (let i = 0; i < european_countries.features.length; i++){
                let country = european_countries.features[i];
                country_name = country.properties.CNTRY_NAME;
                country_code = country_code_mapping.get(country_name);
                //l("country name = " + country_name + " code = " + country_code);


                timePeriods.forEach(year =>  {
                    loadJSON(country_code,year,function(response){
                        let json = JSON.parse(response);

                        let attributes = {
                            SH_H2O_SAFE : 0,
                            SH_SAN_SAFE : 0,
                            SH_SAN_HNDWSH : 0
                        };

                        // l(json);

                        json.data.forEach(entry => {
                            if (entry.dimensions.Location === "ALLAREA") {
                                attributes[entry.series] = parseFloat(entry.value);

                                country.properties["year_" + year.toString()] = attributes;
                            }
                        });
                        let safe_water = L.geoJson(european_countries, {style:styleSafeWater});
                        let safe_sanitation = L.geoJson(european_countries, {style:styleSafeSanitation});
                        let soap_sanitation = L.geoJson(european_countries, {style:styleSoap});

                        let background = {"Clear map" : osm};
                        let foreground = {"Safe and affordable drinking water": safe_water, "Safely managed sanitation" : safe_sanitation, "Handwashing facilities" : soap_sanitation};

                        L.control.layers(background,foreground).addTo(map);
                    });
                });
                return;
            }



            console.log(european_countries);

            //     setIcons(data_2015.water);

        });

        // legend.onAdd = function (map) {
        //
        //     var div = L.DomUtil.create('div', 'info legend'),
        //         grades = [0, 5, 10, 20, 40, 70, 100, 150, 200, 300, 400, 600, 1000],
        //         labels = ["<strong> Einwohner pro km² </strong>"], from, to;
        //
        //
        //
        //     for (var i = 0; i < grades.length; i++) {
        //         from = grades[i];
        //         to = grades[i + 1];
        //
        //         labels.push(
        //             '<i style="background:' + getColor(from + 1) + '"></i> ' +
        //             from + (to ? '&ndash;' + to : '+'));
        //     }
        //     labels.push('<i style="background:' + getColor(grades[0]) + '"></i> ' + 'n/a');
        //     div.innerHTML = labels.join('<br>');
        //     return div;
        //
        //
        // };
        // legend.addTo(map);
    }

    let layerGroup = L.layerGroup();

    function getColorWater(percentage) {
        return percentage > 95 ? '#001a33' :
            percentage > 90 ? '#00264d' :
                percentage > 80 ? '#003366' :
                    percentage > 70 ? '#004080' :
                        percentage > 60 ? '#004d99' :
                            percentage > 50 ? '#0066cc' :
                                percentage > 40 ? '#0080ff' :
                                    percentage > 30 ? '#3399ff' :
                                        percentage > 20 ? '#66b3ff' :
                                            percentage > 10 ? '#99ccff':
                                                percentage > 0 ? '#cce6ff':
                                                    '#888888';
    }

    function getColorSanitation(percentage) {
        return percentage > 95 ? '#001a00' :
            percentage > 90 ? '#003300' :
                percentage > 800 ? '#004d00' :
                    percentage > 70 ? '#006600' :
                        percentage > 60 ? '#008000' :
                            percentage > 50 ? '#00cc00' :
                                percentage > 40 ? '#00e600' :
                                    percentage > 30 ? '#33ff33' :
                                        percentage > 20 ? '#4dff4d' :
                                            percentage > 10 ? '#80ff80' :
                                                percentage > 0 ? '#b3ffb3' :
                                                            '#888888';
    }

    function getColorHandwashing(percentage) {
        return percentage > 95 ? '#1a000d' :
            percentage > 90 ? '#33001a' :
                percentage > 80 ? '#4d0026' :
                    percentage > 70 ? '#660033' :
                        percentage > 60 ? '#800040' :
                            percentage > 50 ? '#b30059' :
                                percentage > 40 ? '#e60073' :
                                    percentage > 30 ? '#ff1a8c' :
                                        percentage > 20 ? '#ff4da6' :
                                            percentage > 10 ? '#ff80bf':
                                                percentage > 0 ? '#ffb3d9':
                                                    '#888888';
    }

    function styleSafeSanitation(feature) {
        return {
            fillColor: getColorSanitation(feature.properties.SH_SAN_SAFE),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.8
        };
    }
    function styleSoap(feature) {
        return {
            fillColor: getColorHandwashing(feature.properties.SH_SAN_HNDWSH),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.8
        };
    }

    function styleSafeWater(feature) {
        l(JSON.stringify(feature.properties));
        return {
            fillColor: getColorWater(feature.properties.year_2015.SH_H2O_SAFE),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.8
        };
    }

    // function getPercentage(country_name) {
    //     // filters useless data
    //
    //
    //     let densities = new Map();
    //
    //     let useless = ['FIPS_ADMIN,C,4', 'GMI_ADMIN,C,254', 'ADMIN_NAME,C,42', 'FIPS_CNTRY,C,2', 'GMI_CNTRY,C,3', 'TYPE_ENG,C,26', 'TYPE_LOC,C,50',
    //         'SQMI,N,12,2', 'COLOR_MAP,C,2', 'test,N,5,3', 'test2,N,5,3'];
    //
    //     for (let entry of administrations) {
    //         for (info of useless) {
    //             delete entry[info]
    //         }
    //
    //         administration_name = entry[a_name];
    //         administration_population = entry[a_pop];
    //         administration_area = entry[a_area];
    //
    //         let pop = parseInt(administration_population);
    //         adjusted_pop = (pop > 0) ? pop : 0;
    //
    //         let area = parseInt(administration_area);
    //
    //         if (densities.has(administration_name)) {
    //             let temp_values = densities.get(administration_name);
    //
    //             temp_values[0] += adjusted_pop;
    //             temp_values[1] += area;
    //
    //             densities.set(administration_name, temp_values);
    //         } else {
    //             densities.set(administration_name, [adjusted_pop, area]);
    //         }
    //     }
    //     return densities;
    // }

    function setIcon(country_name,icon) {
        console.log(country_name);
        var encoded = encodeURI([geocodeUrl, country_name, geocodeParams].join(''));
        var xhr = new XMLHttpRequest();
        xhr.open("GET", encoded, true);
        xhr.responseType = 'json';
        xhr.onload = function () {
            if (xhr.response.length == 0) {
                alert("No place found");
                return;
            }
            let place = xhr.response[0];
            let marker = getMarker(place, icon);
            if (marker !== undefined) {
                marker.addTo(layerGroup);
                marker.bindPopup(name);
            }
        };
        xhr.onerror = function () {
            console.error(xhr.statusText);
        };
        xhr.send();
    }

    function getMarker(place, icon) {
        return L.marker([place.lat, place.lon],
            {icon: icon});
    }

    function setIcons(data) {
        for (const [country_name, percentage] of data.entries()) {
            console.log(country_name);
            console.log(percentage);
            let value = parseFloat(percentage);
            let icon = (value > 99) ? drop_icons[10] :
                (value >= 90) ? drop_icons[9] :
                    (value >= 80) ? drop_icons[8] :
                        (value >= 70) ? drop_icons[7] :
                            (value >= 60) ? drop_icons[6] :
                                (value >= 50) ? drop_icons[5] :
                                    (value >= 40) ? drop_icons[4] :
                                        (value >= 30) ? drop_icons[3] :
                                            (value >= 20) ? drop_icons[2] :
                                                (value >= 10) ? drop_icons[1] :
                                                    drop_icons[0];
            setIcon(country_name, icon);
        }
        layerGroup.addTo(map);
    }
</script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
</body>

</html>