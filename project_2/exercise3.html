<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            font: Arial, Helvetica, sans-serif;
        }

        #checkbox_container,
        .legend {
            padding: 6px 8px;
            line-height: 18px;
            color: #555;
            background-color: #ffffff;
            border-style: solid;
            border-color: black;
            border-width: 1px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        .legend i {
            width: 18px;
            height: 16px;
            float: left;
            margin-right: 8px;
            opacity: 1;
        }

        #checkbox_container {
            position: fixed;
            bottom: 2em;
            left: 1em;
            z-index: 1000;
            opacity: 1.0;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #map_canvas {
            width: 100%;
            height: 90%;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.0/jquery-ui.js"
        integrity="sha256-0YPKAwZP7Mp3ALMRVB2i8GXeEndvCq3eSl/WsAl1Ryk=" crossorigin="anonymous"></script>

</head>


<body onload="initialize()">
    <h1 class="title" leaflet-browser-print-content>Sustainable Development Goal 6.1 & 6.2 in Europe</h1>
    <div id="map_canvas"></div>
    <div id="checkbox_container">
        <h4>Proportion of population:</h4>
        <ul style="list-style-type:none">
            <li>
                <label><input type="radio" name="issue" value="water" checked> using safely managed drinking water services</label>
            </li>
            <li>
                <label><input type="radio" name="issue" value="sanitation"> using safely managed sanitation services</label>
            </li>
            <li>
                <label><input type="radio" name="issue" value="handwash"> with basic handwashing facilities on premises</label>
            </li>
            <li>
                <label><input type="radio" name="issue" value="defect"> practicing open defecation</label>
            </li>
            <li>
        </ul>
        </p>
    </div>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
    <script src="SliderControl.js"></script>

    <script type="text/javascript" src="states-data.js"></script>
    <script>

        const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
        const geocodeParams = '&format=json&limit=1';
        var areaCodes = [
            "112", // Belarus
            "100", // Bulgaria
            "203", // Czechia
            "348", // Hungary
            "498", // Moldova
            "616", // Poland
            "642", // Romania
            "643", // Russia
            "703", // Slovakia
            "804", // Ukraine
            "208", // Denmark
            "233", // Estonia
            "234", // Faroe Island
            "246", // Finland
            "352", // Iceland
            "372", // Ireland
            "833", // Isle of Man
            "428", // Latvia
            "440", // Lithuania
            "578", // Norway
            "752", // Sweden
            "826", // UK
            "008", // Albania
            "020", // Andorra
            "070", // Bosnia
            "191", // Croatia
            "292", // Gibraltar
            "300", // Greece
            "380", // Italy
            "807", // Macedonia
            "470", // Malta
            "499", // Montenegro
            "620", // Portugal
            "674", // San Marino
            "688", // Serbia
            "705", // Slovenia
            "040", // Austria
            "056", // Belgium
            "250", // France
            "276", // Germany
            "438", // Liechtenstein
            "442", // Luxembourg
            "492", // Monaco
            "528", // Netherlands
            "756", // Switzerland
            "724", // Spain
            "826", //	GBR

        ];

        var timePeriods = [
            "2015",
            "2016",
            "2017"
        ]


        function GetTimePeriods() {
            result = "";
            timePeriods.forEach(country => {
                result += ("&timePeriod=" + country);
            })
            return result;
        }

        function GetAreaCodes() {
            result = "";
            areaCodes.forEach(country => {
                result += ("&areaCode=" + country);
            })
            return result;
        }

        function loadJSON(callback) {
            let request = new XMLHttpRequest();
            request.overrideMimeType("application/json");
            request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2' + GetAreaCodes() + GetTimePeriods() + '&pageSize=829', true);
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == "200") {
                    callback(request.responseText);
                }
            };
            request.send(null);
        }

        function DataObject(country, indicator, year, series, value) {
            this.country = country;
            this.indicator = indicator;
            this.year = year;
            this.series = series;
            this.value = value;
        }

        function YearObject(year) {
            this.year = year;
            this.water = new Map();
            this.defect = new Map();
            this.sanitation = new Map();
            this.handwash = new Map();
        }

        let objects = [];

        function getColor(percentage) {
            return percentage > 99 ? '#001a33' :
                percentage > 98 ? '#00264d' :
                    percentage > 97 ? '#003366' :
                        percentage > 96 ? '#004080' :
                            percentage > 95 ? '#004d99' :
                                percentage > 90 ? '#0066cc' :
                                    percentage > 80 ? '#0080ff' :
                                        percentage > 70 ? '#3399ff' :
                                            percentage > 60 ? '#66b3ff' :
                                                percentage > 50 ? '#99ccff' :
                                                    percentage > 0 ? '#cce6ff' :
                                                        '#888888';
        }

        function style(feature, year, issue) {
            //console.log(feature);
            //console.log(year);
            let data = getData(feature, year);
            let dataIssue = getIssue(data, issue);
            if (dataIssue == undefined) {
                dataIssue = 0;
            }
            console.log(dataIssue);


            return {
                fillColor: getColor(dataIssue.value),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '1',
                fillOpacity: 1
            };
        }

        let europeData2015;
        let europeData2016;
        let europeData2017;

        function getData(feature, year) {
            let data;
            if (year == "2015") {
                data = feature.data_2015;
            } else if (year == "2016") {
                data = feature.data_2016;
            } else {
                data = feature.data_2017;
            }
            return data;
        }

        function getIssue(data, issue) {
            if (issue == "water") {
                return data.water;
            } else if (issue == "sanitation") {
                return data.sanitation;
            } else if (issue == "defect") {
                return data.defect;
            } else {
                return data.handwash;
            }
        }


        // define functionality for every geoJson feature
        function onEachFeature(feature, layer, year, issue) {
            //calculate Population Density
            let data = getData(feature, year);
            let dataIssue = getIssue(data, issue);
            console.log(dataIssue);

            if (dataIssue == undefined) {
                dataIssue = 0;
            }
            //console.log(feature);

            if (dataIssue.value >= 0) {
                layer.bindPopup("<b>" + feature.properties.CNTRY_NAME + "</b><br>" + dataIssue.value + "%");
            } else {
                layer.bindPopup("<b>" + feature.properties.CNTRY_NAME + "</b><br><b>Kein Wert vorhanden</b><br>");
            }
        }
        let europe = [];
        let sliderControl;
        let layer;
        let map = L.map('map_canvas').setView([55, 10], 4);

        // call on load
        function initialize() {

            // initialize map
            let osm = new L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            }).addTo(map);
            var shapefile = 'files/World/Cntry00';

            //get european countries
            shp(shapefile).then(function (data) {
                data.features.forEach(country => {
                    if (country.properties.FIRST_FIRS == "Europe") {
                        europe.push(country);
                    }
                });
                data.input = [];
            });

            loadJSON(function (response) {
                let json = JSON.parse(response);
                json.data.forEach(country => {
                    objects.push(new DataObject(country.geoAreaName, country.indicator, country.timePeriodStart, country.series, country.value))
                });
                let data_2015 = new YearObject("2015");
                let data_2016 = new YearObject("2016");
                let data_2017 = new YearObject("2017");

                objects.forEach(country => {
                    if (country.year == "2015") {
                        sortToIssue(country, data_2015);
                    } else if (country.year == "2016") {
                        sortToIssue(country, data_2016);
                    } else {
                        sortToIssue(country, data_2017);
                    }
                });

                europe.forEach(input => {
                    matchCountry(input);
                    input.data_2015 = [];
                    input.data_2016 = [];
                    input.data_2017 = [];
                    input.data_2015.water = data_2015.water.get(input.properties.CNTRY_NAME);
                    input.data_2016.water = data_2016.water.get(input.properties.CNTRY_NAME);
                    input.data_2017.water = data_2017.water.get(input.properties.CNTRY_NAME);
                    input.data_2015.sanitation = data_2015.sanitation.get(input.properties.CNTRY_NAME);
                    input.data_2016.sanitation = data_2016.sanitation.get(input.properties.CNTRY_NAME);
                    input.data_2017.sanitation = data_2017.sanitation.get(input.properties.CNTRY_NAME);
                    input.data_2015.handwash = data_2015.handwash.get(input.properties.CNTRY_NAME);
                    input.data_2016.handwash = data_2016.handwash.get(input.properties.CNTRY_NAME);
                    input.data_2017.handwash = data_2017.handwash.get(input.properties.CNTRY_NAME);
                    input.data_2015.defect = data_2015.defect.get(input.properties.CNTRY_NAME);
                    input.data_2016.defect = data_2016.defect.get(input.properties.CNTRY_NAME);
                    input.data_2017.defect = data_2017.defect.get(input.properties.CNTRY_NAME);
                });

                //console.log(europe);

                //Default-slider: water
                addSlider("water");
                /*let radioBox = L.control({ position: 'bottomleft' });
                                radioBox.onAdd = function (map) {
                                    let div = L.DomUtil.create('div', 'checkbox_container');
                                    div.innerHTML = '<fieldset id="changeItem"><h3>GOAL 6</h3><ul style="list-style-type:none">' +
                                        '<li><label><input type="radio" name="issue" value="water" checked>INDICATOR 6.1.1:  SH_H2O_SAFE</label></li>' +
                                        '<li><label><input type="radio" name="issue" value="sanitation">INDICATOR 6.2.1:  SH_SAN_SAFE</label></li>' +
                                        '<li><label><input type="radio" name="issue" value="handwash">INDICATOR 6.2.1: SH_SAN_HNDWSH</label></li>' +
                                        '<li><label><input type="radio" name="issue" value="defect">INDICATOR 6.2.1: SH_SAN_DEFECT</label></li></ul></fieldset>';
                                    return div;
                                };
                                radioBox.addTo(map);*/
                let legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    let div = L.DomUtil.create('div', 'info legend'),
                        grades = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 95],
                        labels = ["<strong>Percentage</strong>"],
                        from, to;
                    for (var i = 0; i < grades.length; i++) {
                        from = grades[i];
                        to = grades[i + 1];
                        console.log(getColor(from + 1));

                        labels.push(
                            '<i style="background:' + getColor(from + 1) + '"></i> ' +
                            from + (to ? '&ndash;' + to : '+'));
                    }
                    labels.push('<i style="background:' + getColor(0) + '"></i> ' + 'n/a');
                    div.innerHTML = labels.join('<br>');
                    return div;
                };
                legend.addTo(map);
            });
        }


        function addSlider(issue) {
            let europeData2015 = L.geoJson(europe, {
                style: function (feature) { return style(feature, "2015", issue) },
                onEachFeature: function (feature, layer) { return onEachFeature(feature, layer, "2015", issue) },
                time: "2015"
            }).addTo(map);
            let europeData2016 = L.geoJson(europe, {
                style: function (feature) { return style(feature, "2016", issue) },
                onEachFeature: function (feature, layer) { return onEachFeature(feature, layer, "2016", issue) },
                time: "2016"
            }).addTo(map);
            let europeData2017 = L.geoJson(europe, {
                style: function (feature) { return style(feature, "2017", issue) },
                onEachFeature: function (feature, layer) { return onEachFeature(feature, layer, "2017", issue) },
                time: "2017"
            }).addTo(map);

            //now add each geojson layer to a single layer group, as the slider take only one layer
            layer = L.layerGroup([europeData2015, europeData2016, europeData2017]);

            //initiate slider, follow = 1 means, show one feature at a time
            sliderControl = L.control.sliderControl({ layer: layer, follow: 1 });
            map.addControl(sliderControl);//add slider to map
            sliderControl.startSlider();
        }


        function matchCountry(input) {
            if (input.properties.CNTRY_NAME == "Faroe Is.") {
                input.properties.CNTRY_NAME = "Faroe Islands";
            } else if (input.properties.CNTRY_NAME == "United Kingdom") {
                input.properties.CNTRY_NAME = "United Kingdom of Great Britain and Northern Ireland";
            } else if (input.properties.CNTRY_NAME == "Bosnia & Herzegovina") {
                input.properties.CNTRY_NAME = "Bosnia and Herzegovina";
            } else if (input.properties.CNTRY_NAME == "Czech Republic") {
                input.properties.CNTRY_NAME = "Czechia";
            } else if (input.properties.CNTRY_NAME == "Moldova") {
                input.properties.CNTRY_NAME = "Republic of Moldova";
            } else if (input.properties.CNTRY_NAME == "Serbia & Montenegro") {
                input.properties.CNTRY_NAME = "Serbia";
            } else if (input.properties.CNTRY_NAME == "Macedonia") {
                input.properties.CNTRY_NAME = "North Macedonia";
            }
        }

        $('#checkbox_container').change(function () {
            event.preventDefault();
            sliderControl.onRemove(map);
            let issue = $("input[name='issue']:checked").val();
            addSlider(issue);
        });


        function sortToIssue(country, data) {
            if (country.indicator == "6.1.1") {
                data.water.set(country.country, country);
            } else if (country.series == "SH_SAN_DEFECT") {
                data.defect.set(country.country, country);
            } else if (country.series == "SH_SAN_SAFE") {
                data.sanitation.set(country.country, country);
            } else if (country.series == "SH_SAN_HNDWSH") {
                data.handwash.set(country.country, country);
            }
        }

    </script>
</body>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"> </script>

</html>