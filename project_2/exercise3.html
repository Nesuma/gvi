<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #map_canvas {
            width: 100%;
            height: 95%;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background-color: #ffffff;
            border-style: solid;
            border-color: black;
            border-width: 1px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #4CAF50;
            cursor: pointer;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body onload="initialize()">
<div id="map_canvas"></div>
<input type="range" min="2000" max="2018" value="2015" class="slider" id="myRange">
<div class="slider_div">

</div>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
<script type="text/javascript" src="states-data.js"></script>
<script>
    let map;
    const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
    const geocodeParams = '&format=json&limit=1';
    let year;
    let european_countries;
    let foreground;
    let background;

    let control;

    let country_code_mapping = new Map([
        ["Belarus", "112"],
        ["Bulgaria", "100"],
        ["Czechia", "203"],
        ["Czech Republic", "203"],
        ["Hungary", "348"],
        ["Moldova", "498"],
        ["Republic of Moldova", "498"],
        ["Poland", "616"],
        ["Romania", "642"],
        ["Russian Federation", "643"],
        ["Russia", "643"],
        ["Slovakia", "703"],
        ["Ukraine", "804"],
        ["Denmark", "208"],
        ["Estonia", "233"],
        ["Faroe Islands", "234"],
        ["Faroe Is.", "234"],
        ["Finland", "246"],
        ["Iceland", "352"],
        ["Ireland", "372"],
        ["Isle of Man", "833"],
        ["Latvia", "428"],
        ["Lithuania", "440"],
        ["Norway", "578"],
        ["Sweden", "752"],
        ["Montenegro", "499"],
        ["United Kingdom", "826"],
        ["United Kingdom of Great Britain and Northern Ireland", "826"],
        ["Albania", "008"],
        ["Andorra", "020"],
        ["Bosnia and Herzegovina", "070"],
        ["Bosnia & Herzegovina", "070"],
        ["Croatia", "191"],
        ["Gibraltar", "292"],
        ["Greece", "300"],
        ["Italy", "380"],
        ["North Macedonia", "807"],
        ["Macedonia", "807"],
        ["Malta", "470"],
        ["Portugal", "620"],
        ["San Marino", "674"],
        ["Serbia and Montenegro", "688"],
        ["Serbia & Montenegro", "688"],
        ["Serbia", "688"],
        ["Slovenia", "705"],
        ["Austria", "040"],
        ["Belgium", "056"],
        ["France", "250"],
        ["Germany", "276"],
        ["Liechtenstein", "438"],
        ["Luxembourg", "442"],
        ["Monaco", "492"],
        ["Netherlands", "528"],
        ["Switzerland", "756"],
        ["Spain", "724"],
        ["Svalbard and Jan Mayen Islands", "744"],
        ["Svalbard", "744"],
        ["Jan Mayen", "744"],
        ["Guernsey", "831"],
        ["Jersey", "832"],
        ["Sark", "680"],
        ["Holy See", "336"],
        ["Vatican City", "336"],
        ["Vatican", "336"]

    ]);
    let attribute_mapping = new Map([
        ["Safe and affordable drinking water", "SH_H2O_SAFE"],
        ["Safely managed sanitation", "SH_SAN_SAFE"],
        ["Handwashing facilities", "SH_SAN_HNDWSH"]
    ]);

    let timePeriods = [
        "2000",
        "2001",
        "2002",
        "2003",
        "2004",
        "2005",
        "2006",
        "2007",
        "2008",
        "2009",
        "2010",
        "2011",
        "2012",
        "2013",
        "2014",
        "2015",
        "2016",
        "2017",
        "2018"
    ];

    let legend_h2o_safe = L.control({position: 'bottomright'});
    let legend_save_hndwsh = L.control({position: 'bottomright'});
    let legend_safe_san = L.control({position: 'bottomright'});

    function initialize() {
        map = L.map('map_canvas').setView([53.81, 14.16], 3.5);

        let osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            minZoom: 2,
            maxZoom: 18
        }).addTo(map);

        var slider = document.getElementById("myRange")
        year = slider.value; // Display the default slider value
        l("default slider year = " + year);

        slider.oninput = function () {
            for (let key in foreground) {
                if (map.hasLayer(foreground[key])) {
                    //slider non functional until a layer is set
                    year = this.value;
                    l("slider year: " + year.toString());

                    l("map is showing " + key);
                    map.removeLayer(foreground[key]);
                    control.removeLayer(foreground[key]);
                    foreground[key] = L.geoJson(european_countries, {
                        style: function (feature) {
                            return style(feature, year, key);
                        }
                    });
                    control.addOverlay(foreground[key], key);
                    map.addLayer(foreground[key]);
                    break;
                }
            }
        };

        shp("files/World/Cntry00").then(countries => {
            european_countries = getEuropeanCountries(countries);

            // adds default values for every possible data to all countries
            for (let c of european_countries.features) {
                for (y of timePeriods) {
                    let attributes = {
                        SH_H2O_SAFE: 0,
                        SH_SAN_SAFE: 0,
                        SH_SAN_HNDWSH: 0
                    };
                    c.properties["year_"+y] = attributes;
                }
            }

            loadJSON(function (response) {
                let json = JSON.parse(response);

                for (let entry of json.data) {
                    let country = getCountry(entry.geoAreaName, european_countries);

                    // countries without polygons or data for all area are ignored
                    if ((country !== undefined) && (entry.dimensions.Location === "ALLAREA")) {
                        // adds the value to the corresponding time period and series (e.g. year_2015.SH_H2O_SAFE)
                        country.properties["year_" + entry.timePeriodStart.toString()][entry.series] = parseFloat(entry.value);
                    }
                }

                l(european_countries);

                let safe_water = L.geoJson(european_countries, {
                    style: function (feature) {
                        return style(feature, year, "Safe and affordable drinking water")
                    }
                });
                let safe_sanitation = L.geoJson(european_countries, {
                    style: function (feature) {
                        return style(feature, year, "Safely managed sanitation")
                    }
                });
                let soap_sanitation = L.geoJson(european_countries, {
                    style: function (feature) {
                        return style(feature, year, "Handwashing facilities")
                    }
                });

                background = {"Clear map": osm};
                foreground = {
                    "Safe and affordable drinking water": safe_water,
                    "Safely managed sanitation": safe_sanitation,
                    "Handwashing facilities": soap_sanitation,
                    // "Safe and affordable drinking water icons" : safe_water_icons,
                    // "Safely managed sanitation icons" : safe_sanitation_icons,
                    // "Handwashing facilities icons" : soap_icons

                };
                // let safe_water_icons = L.layerGroup();
                // addIcons(safe_water_icons,european_countries,"drop",0,"SH_H2O_SAFE");
                // let safe_sanitation_icons = L.layerGroup();
                // addIcons(safe_sanitation_icons,european_countries,"toilet",20,"SH_SAN_SAFE");
                // let soap_icons = L.layerGroup();
                // addIcons(soap_icons,european_countries,"soap",40,"SH_SAN_HNDWSH");

                control = L.control.layers(background, foreground).addTo(map);
                control.collapsed = false;
            });
        });


        legend_h2o_safe.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 50, 60, 70, 80, 90, 95, 96, 97, 98, 99],
                labels = ["<strong>Population percentage with access to safe and affordable drinking water</strong>"], from, to;

            for (var i = 0; i < grades.length; i++) {
                from = grades[i];
                to = grades[i + 1];

                labels.push(
                    '<i style="background:' + getColorWater(from + 1) + '"></i> ' +
                    from + (to ? '&ndash;' + to : '+'));
            }
            labels.push('<i style="background:' + getColorWater(grades[0]) + '"></i> ' + 'n/a');
            div.innerHTML = labels.join('<br>');
            return div;
        };

        legend_save_hndwsh.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 10, 20, 30, 40, 50, 60,70,80,90,95],
                labels = ["<strong>Population percentage with access to safe and affordable drinking water</strong>"], from, to;

            for (var i = 0; i < grades.length; i++) {
                from = grades[i];
                to = grades[i + 1];

                labels.push(
                    '<i style="background:' + getColorHandwashing(from + 1) + '"></i> ' +
                    from + (to ? '&ndash;' + to : '+'));
            }
            labels.push('<i style="background:' + getColorHandwashing(grades[0]) + '"></i> ' + 'n/a');
            div.innerHTML = labels.join('<br>');
            return div;
        };

        legend_safe_san.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 10, 20, 30, 40, 50, 60,70,80,90,95],
                labels = ["<strong>Population percentage with access to safe and affordable drinking water</strong>"], from, to;

            for (var i = 0; i < grades.length; i++) {
                from = grades[i];
                to = grades[i + 1];

                labels.push(
                    '<i style="background:' + getColorSanitation(from + 1) + '"></i> ' +
                    from + (to ? '&ndash;' + to : '+'));
            }
            labels.push('<i style="background:' + getColorSanitation(grades[0]) + '"></i> ' + 'n/a');
            div.innerHTML = labels.join('<br>');
            return div;
        };

        map.on("overlayremove",function(eventLayer){
            this.removeControl(legend_safe_san);
            this.removeControl(legend_save_hndwsh);
            this.removeControl(legend_h2o_safe);
        });
        map.on('overlayadd', function (eventLayer) {
            // Switch to the Population legend...
            if (eventLayer.name === "Safe and affordable drinking water") {
                legend_h2o_safe.addTo(this);
            } else if (eventLayer.name === "Safely managed sanitation"){ // Or switch to the Population Change legend...
                legend_safe_san.addTo(this);
            } else {
                //"Handwashing facilities"
                legend_save_hndwsh.addTo(this);
            }
        });

    }

    // reads the icons from local directory. Offset is used to show them next to each other
    function getIcons(path, icon_name, offset) {
        let icons = [];
        for (i = 0; i <= 10; i++) {
            // let factor = (10 + 10 - i) / 10;
            let factor = 1;
            icons[i] = L.icon({
                iconUrl: path + '/' + icon_name + (i * 10) + '.png',
                iconSize: [20 * factor, 35 * factor], // size of the icon
                iconAnchor: [20 + offset, 30],
                popupAnchor: [offset, -32]
            });
        }
        return icons;
    }

    // concatenates time periods for rest call
    function GetTimePeriods() {
        let result = "";
        timePeriods.forEach(element => {
            result += ("&timePeriod=" + element);
        });
        return result;
    }

    // concatenates area codes for rest call
    function GetAreaCodes() {
        let result = "";
        for (const [key, value] of country_code_mapping.entries()) {
            result += ("&areaCode=" + value);
        }
        return result;
    }

    // Fetches the data from the SDG API
    function loadJSON(callback) {
        let request = new XMLHttpRequest();
        request.overrideMimeType("application/json");
        request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2' + GetAreaCodes() + GetTimePeriods() + "&pageSize=100000", true);
        request.onreadystatechange = function () {
            if (request.readyState == 4 && request.status == "200") {
                l("Retrieved data");
                callback(request.responseText);
            }
        };
        request.send(null);
    }

    // searches list of country for specified name. Uses the area codes to map
    function getCountry(name, countries) {
        for (let country of countries.features) {
            if (country_code_mapping.get(country.properties.CNTRY_NAME) === country_code_mapping.get(name)) {
                return country;
            }
        }
    }

    // returns the right function for each data
    function getColorFunction(key) {
        return (key === "Safe and affordable drinking water") ? getColorWater :
            (key === "Safely managed sanitation") ? getColorSanitation :
                getColorHandwashing;
    }

    //  adds all icons for one type of indicator, e.g. SH_H2O_SAFE
    function addIcons(layer_group, countries, icon_name, offset, indicator) {
        for (country of countries.features) {
            let value = country.properties.year_2015[indicator];
            let name = country.properties.CNTRY_NAME;
            let icons = getIcons("images", icon_name, offset);
            setIcon(layer_group, name, value, icons);
        }
    }

    // creates a new marker on the position of the specified country showing the right icon for the given value
    function setIcon(layer, country_name, value, icons) {
        // console.log("setting icon for " + country_name);
        let icon = getIcon(value, icons);
        var encoded = encodeURI([geocodeUrl, country_name, geocodeParams].join(''));
        var xhr = new XMLHttpRequest();
        xhr.open("GET", encoded, true);
        xhr.responseType = 'json';
        xhr.onload = function () {
            if (xhr.response.length == 0) {
                alert("No place found");
                return;
            }
            let place = xhr.response[0];
            let marker = getMarker(place, icon);
            if (marker !== undefined) {
                marker.addTo(layer);
                marker.bindPopup(value);
            }
        };
        xhr.onerror = function () {
            console.error(xhr.statusText);
        };
        xhr.send();
    }

    // creates a marker
    function getMarker(place, icon) {
        return L.marker([place.lat, place.lon],
            {icon: icon});
    }

    // returns right icon for each percentage
    function getIcon(value, icons) {
        return (value > 99) ? icons[10] :
            (value >= 90) ? icons[9] :
                (value >= 80) ? icons[8] :
                    (value >= 70) ? icons[7] :
                        (value >= 60) ? icons[6] :
                            (value >= 50) ? icons[5] :
                                (value >= 40) ? icons[4] :
                                    (value >= 30) ? icons[3] :
                                        (value >= 20) ? icons[2] :
                                            (value >= 10) ? icons[1] :
                                                icons[0];
    }

    // returns right color for each percentage
    function getColorWater(percentage) {
        return percentage > 99 ? '#001a33' :
            percentage > 98 ? '#00264d' :
                percentage > 97 ? '#003366' :
                    percentage > 96 ? '#004080' :
                        percentage > 95 ? '#004d99' :
                            percentage > 90 ? '#0066cc' :
                                percentage > 80 ? '#0080ff' :
                                    percentage > 70 ? '#3399ff' :
                                        percentage > 60 ? '#66b3ff' :
                                            percentage > 50 ? '#99ccff' :
                                                percentage > 0 ? '#cce6ff' :
                                                    '#888888';
    }

    // returns right color for each percentage
    function getColorSanitation(percentage) {
        return percentage > 95 ? '#001a00' :
            percentage > 90 ? '#003300' :
                percentage > 80 ? '#004d00' :
                    percentage > 70 ? '#006600' :
                        percentage > 60 ? '#008000' :
                            percentage > 50 ? '#00cc00' :
                                percentage > 40 ? '#00e600' :
                                    percentage > 30 ? '#33ff33' :
                                        percentage > 20 ? '#4dff4d' :
                                            percentage > 10 ? '#80ff80' :
                                                percentage > 0 ? '#b3ffb3' :
                                                    '#888888';
    }

    // returns right color for each percentage
    function getColorHandwashing(percentage) {
        return percentage > 95 ? '#1a000d' :
            percentage > 90 ? '#33001a' :
                percentage > 80 ? '#4d0026' :
                    percentage > 70 ? '#660033' :
                        percentage > 60 ? '#800040' :
                            percentage > 50 ? '#b30059' :
                                percentage > 40 ? '#e60073' :
                                    percentage > 30 ? '#ff1a8c' :
                                        percentage > 20 ? '#ff4da6' :
                                            percentage > 10 ? '#ff80bf' :
                                                percentage > 0 ? '#ffb3d9' :
                                                    '#888888';
    }

    // year is specified by slider, key is specified by current active layer
    function style(feature, year, key) {
        let getColor = getColorFunction(key);
        let attribute = attribute_mapping.get(key);
        // l((feature.properties["year_" + year][attribute]));
        return {
            fillColor: getColor(feature.properties["year_" + year][attribute]),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.8
        };
    }

    // filters all countries not in europe
    function getEuropeanCountries(json) {
        let features = [];
        for (let i = 0; i < json.features.length; i++) {
            if (json.features[i].properties.FIRST_FIRS === "Europe") {
                features.push(json.features[i]);
            }
        }
        json.features = features;
        return json;
    }

    // QOL
    function l(i) {
        console.log(i);
    }

</script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
</body>

</html>