<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <value>Leaflet</value>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #map_canvas {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body onload="initialize()">

    <div id="map_canvas"></div>
    <div id="checkbox_container">
        <form>
            <p>Jahr:</p>
            <fieldset onchange="update()"">
                <input type="radio" id="2015" name="answer" value="2015" checked>
                <label for="2015"> 2015</label>
                <input type="radio" id="2016" name="answer" value="2016">
                <label for="2016"> 2016</label>
                <input type="radio" id="2017" name="answer" value="2017">
                <label for="2017"> 2017</label>
            </fieldset>
        </form>
    </div>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
    <script type="text/javascript" src="states-data.js"></script>
    <script>
        var map;
        const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
        const geocodeParams = '&format=json&limit=1';
        var drop0 = L.icon({
            iconUrl: 'images/drop0.png',
            iconSize: [20, 35], // size of the icon
            iconAnchor: [20, 30],
            popupAnchor: [0, -32]
        });
        var areaCodes = [
            "112", // Belarus
            "100", // Bulgaria
            "203", // Czechia
            "348", // Hungary
            "498", // Moldova
            "616", // Poland
            "642", // Romania
            "643", // Russia
            "703", // Slovakia
            "804", // Ukraine
            "208", // Denmark
            "233", // Estonia
            "234", // Faroe Island
            "246", // Finland
            "352", // Iceland
            "372", // Ireland
            "833", // Isle of Man
            "428", // Latvia
            "440", // Lithuania
            "578", // Norway
            "752", // Sweden
            "826", // UK
            "008", // Albania
            "020", // Andorra
            "070", // Bosnia
            "191", // Croatia
            "292", // Gibraltar
            "300", // Greece
            "380", // Italy
            "807", // Macedonia
            "470", // Malta
            "499", // Montenegro
            "620", // Portugal
            "674", // San Marino
            "688", // Serbia
            "705", // Slovenia
            "040", // Austria
            "056", // Belgium
            "250", // France
            "276", // Germany
            "438", // Liechtenstein
            "442", // Luxembourg
            "492", // Monaco
            "528", // Netherlands
            "756", // Switzerland
            "724", // Spain
            "826", //	GBR

        ];

        var timePeriods = [
            "2015",
            "2016",
            "2017"
        ]

        function GetTimePeriods() {
            result = "";
            timePeriods.forEach(country => {
                result += ("&timePeriod=" + country);
            })
            return result;
        }

        function GetAreaCodes() {
            result = "";
            areaCodes.forEach(country => {
                result += ("&areaCode=" + country);
            })
            return result;
        }

        function loadJSON(callback) {
            let request = new XMLHttpRequest();
            request.overrideMimeType("application/json");
            //request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2&areaCode=112&areaCode=100&areaCode=203&areaCode=348&areaCode=616&areaCode=498&areaCode=642&areaCode=643&areaCode=703&areaCode=804&areaCode=208&areaCode=233&areaCode=234&areaCode=246&areaCode=352&areaCode=372&areaCode=833&areaCode=428&areaCode=440&areaCode=578&areaCode=744&areaCode=752&areaCode=826&areaCode=8&areaCode=20&areaCode=70&areaCode=191&areaCode=292&areaCode=300&areaCode=336&areaCode=380&areaCode=470&areaCode=499&areaCode=807&areaCode=620&areaCode=674&areaCode=688&areaCode=705&areaCode=724&areaCode=40&areaCode=56&areaCode=250&areaCode=276&areaCode=438&areaCode=442&areaCode=492&areaCode=528&areaCode=756&timePeriod=2015&timePeriod=2016&timePeriod=2017', true);
            //Europe: request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2&areaCode=150&timePeriod=2015&timePeriod=2016&timePeriod=2017', true);
            // request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2&areaCode=112&areaCode=' +
            //     '100&areaCode=203&areaCode=348&areaCode=616&areaCode=498&areaCode=642&areaCode=643&areaCode=703&areaCode=804&areaCode=208&' +
            //     'areaCode=233&areaCode=234&areaCode=246&areaCode=352&areaCode=372&areaCode=833&areaCode=428&areaCode=440&areaCode=578&areaCode=' +
            //     '744&areaCode=752&areaCode=826&areaCode=8&areaCode=20&areaCode=70&areaCode=191&areaCode=292&areaCode=300&areaCode=336&areaCode=' +
            //     '380&areaCode=470&areaCode=499&areaCode=807&areaCode=620&areaCode=674&areaCode=688&areaCode=705&areaCode=724&areaCode=40&areaC' +
            //     'ode=56&areaCode=250&areaCode=276&areaCode=438&areaCode=442&areaCode=492&areaCode=528&areaCode=756&timePeriod=2015&timePeriod' +
            //     '=2016&timePeriod=2017&pageSize=829', true);
            request.open('GET', 'https://unstats.un.org/SDGAPI/v1/sdg/Target/Data?target=6.1&target=6.2' + GetAreaCodes() + GetTimePeriods() + '&pageSize=829', true);
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == "200") {
                    callback(request.responseText);
                }
            };
            request.send(null);
        }

        function DataObject(country, indicator, year, series, value) {
            this.country = country;
            this.indicator = indicator;
            this.year = year;
            this.series = series;
            this.value = value;
        }

        function YearObject(year) {
            this.year = year;
            this.water = new Map();
            this.defect = new Map();
            this.sanitation = new Map();
            this.handwash = new Map();
        }

        let objects = [];



        /*function initialize() {
            loadJSON(function (response) {
                let json = JSON.parse(response);
                json.data.forEach(country => {
                    objects.push(new DataObject(country.geoAreaName, country.indicator, country.timePeriodStart, country.series, country.value,))
                });
                let data_2015 = new YearObject("2015");
                let data_2016 = new YearObject("2016");
                let data_2017 = new YearObject("2017");

                objects.forEach(country => {
                    if (country.year == "2015") {
                        if (country.indicator == "6.1.1") {
                            data_2015.water.push(country);
                        } else {
                            data_2015.soap.push(country);
                        }
                    } else if (country.year == "2016") {
                        if (country.indicator == "6.1.1") {
                            data_2016.water.push(country);
                        } else {
                            data_2016.soap.push(country);
                        }
                    } else {
                        if (country.indicator == "6.1.1") {
                            data_2017.water.push(country);
                        } else {
                            data_2017.soap.push(country);
                        }
                    }
                });
                console.log(data_2015);

                data_2015.water.forEach(country => {
                    geocode(country);
                })
            });

            map = L.map('map_canvas').setView([53.81, 14.16], 3.5);

            var osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                minZoom: 2,
                maxZoom: 18
            });
            L.geoJson(statesData).addTo(map);
            map.addLayer(osm);
            /**
             * place marker with balloon
             * and user defines Icon
             *
             * /

        }*/

        function getColor(density) {
            return density > 1000 ? '#00001a' :
                density > 600 ? '#000033' :
                    density > 400 ? '#00004d' :
                        density > 300 ? '#000066' :
                            density > 200 ? '#000080' :
                                density > 150 ? '#0000cc' :
                                    density > 100 ? '#0000e6' :
                                        density > 70 ? '#3333ff' :
                                            density > 40 ? '#4d4dff' :
                                                density > 20 ? '#8080ff' :
                                                    density > 10 ? '#b3b3ff' :
                                                        density > 5 ? '#ccccff' :
                                                            density > 0 ? '#e6e6ff' :
                                                                '#dddddd';
        }

        function update() {
            var geo = L.geoJson(europe, { style: style, onEachFeature: onEachFeature }).addTo(map);
        }
        // define polygon style
        function style(feature) {
            console.log(feature);
            let data = getData(feature);
            if (data == undefined) {
                return;
            }
            return {
                fillColor: getColor(data.value),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '1',
                fillOpacity: 0.7
            };
        }

        function getData(feature) {
            let data;
            let year_2015 = document.getElementById("2015").checked;
            let year_2016 = document.getElementById("2016").checked;
            let year_2017 = document.getElementById("2017").checked;
            if (year_2015 == true) {
                data = feature.data_2015;
            } else if (year_2016 == true) {
                data = feature.data_2016;
            } else {
                data = feature.data_2017;
            }
            return data;
        }

        // define functionality for every geoJson feature
        function onEachFeature(feature, layer) {
            //calculate Population Density
            let popDensity = 0
            if (feature.data != undefined) {
                popDensity = feature.data.value;
            }
            //console.log(feature);

            //add Pop-up with Population Density
            if (popDensity >= 0) {
                let out = "<b>" + feature.properties.ADMIN_NAME + ", " + feature.properties.CNTRY_NAME + "</b><br>" + popDensity + " Zugang zu Seife";
                layer.bindPopup(out);
            } else {
                let out = "<b>Keine Daten</b><br>";
                layer.bindPopup(out);
            }
        }
        let europe = [];


        // call on load
        function initialize() {

            // initialize map
            let map = L.map('map_canvas').setView([48.75, 9.21], 7);

            let osm = new L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            }).addTo(map);
            var shapefile = 'files/World/Cntry00';

            //get european countries
            shp(shapefile).then(function (data) {
                data.features.forEach(country => {
                    if (country.properties.FIRST_FIRS == "Europe") {
                        europe.push(country);
                    }
                });
                data.input = [];
            });

            loadJSON(function (response) {
                let json = JSON.parse(response);
                json.data.forEach(country => {
                    objects.push(new DataObject(country.geoAreaName, country.indicator, country.timePeriodStart, country.series, country.value))
                });
                let data_2015 = new YearObject("2015");
                let data_2016 = new YearObject("2016");
                let data_2017 = new YearObject("2017");

                objects.forEach(country => {
                    if (country.year == "2015") {
                        sortToIssue(country, data_2015);
                    } else if (country.year == "2016") {
                        sortToIssue(country, data_2016);
                    } else {
                        sortToIssue(country, data_2017);
                    }
                });


                console.log(data_2015);

                /*data_2015.sanitation.forEach(country => {
                    europe.forEach(input => {
                        //console.log(input);
                        //match countries
                        if (input.properties.CNTRY_NAME == country.country) {
                            input.data = country;
                        } else if (country.country.includes(input.properties.CNTRY_NAME)
                            || input.properties.CNTRY_NAME.includes(country.country)) {
                            input.data = country;
                        } else if (input.properties.CNTRY_NAME == "Bosnia & Herzegovina"
                            && country.country == "Bosnia and Herzegovina") {
                            input.data = country;
                        } else if (input.properties.CNTRY_NAME == "Czech Republic"
                            && country.country == "Czechia") {
                            input.data = country;
                        }
                    });
                })*/

                europe.forEach(input => {
                    input.data_2015 = data_2015.water.get(input.properties.CNTRY_NAME);
                    input.data_2016 = data_2016.water.get(input.properties.CNTRY_NAME);
                    input.data_2017 = data_2017.water.get(input.properties.CNTRY_NAME);
                })
                console.log(europe);

                //Möglichkeiten: 1. Vergleich Countries, 2. Während shape 
                var geo = L.geoJson(europe, { style: style, onEachFeature: onEachFeature }).addTo(map);

                let baseMaps = { "BaseLayer": osm };
                let overlays = { "PopDensity": geo };

                L.control.layers(baseMaps, overlays).addTo(map);

            });



        }

        function sortToIssue(country, data) {
            if (country.indicator == "6.1.1") {
                data.water.set(country.country, country);
            } else if (country.series == "SH_SAN_DEFECT") {
                data.defect.set(country.country, country);
            } else if (country.series == "SH_SAN_SAFE") {
                data.sanitation.set(country.country, country);
            } else if (country.series == "SH_SAN_HNDWSH") {
                data.handwash.set(country.country, country);
            }
        }

    </script>
</body>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"> </script>

</html>